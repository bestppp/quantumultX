// å»ºè¡ŒCookieè‡ªåŠ¨æå–å·¥å…·
const COOKIE_KEY = "ccb_auth_cookie";

if (typeof $response !== 'undefined') {
    try {
        // æ£€æµ‹ç™»å½•æˆåŠŸå“åº”
        if ($response.status == 200 && $request.url.includes('auth/login')) {
            const data = JSON.parse($response.body);
            
            if (data.code === 'SUCCESS') {
                // æå–å…³é”®Cookie
                const cookieHeader = $response.headers['Set-Cookie'] || "";
                const tokenMatch = cookieHeader.match(/SESSION=([^;]+)/);
                const userIdMatch = cookieHeader.match(/USER_ID=([^;]+)/);
                
                if (tokenMatch && userIdMatch) {
                    const authCookie = `SESSION=${tokenMatch[1]}; USER_ID=${userIdMatch[1]}`;
                    
                    // æŒä¹…åŒ–å­˜å‚¨
                    $prefs.setValueForKey(authCookie, COOKIE_KEY);
                    $prefs.setValueForKey(Date.now(), "ccb_cookie_time");
                    
                    // æˆåŠŸé€šçŸ¥
                    $notification.post(
                        "ğŸ€ å»ºè¡ŒCookieå·²æ›´æ–°", 
                        "é‡è¦å‡­è¯è·å–æˆåŠŸ", 
                        "å³å°†è‡ªåŠ¨å¼€å§‹ç­¾åˆ°ä»»åŠ¡",
                        { "open-url": "ccbcloud://" }
                    );
                    
                    // 3ç§’åè‡ªåŠ¨å¯åŠ¨ç­¾åˆ°
                    $task.delay({
                        seconds: 3
                    }, () => {
                        $task.run({
                            script: $prefs.valueForKey("ccb_sign_url") || "https://raw.githubusercontent.com/yourname/repo/main/ccb_sign.js"
                        });
                    });
                }
            }
        }
    } catch (e) {
        $notification.post("âš ï¸ Cookieæå–å¤±è´¥", e.message, "");
    }
    $done({});
}
