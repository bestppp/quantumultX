// å»ºè¡Œè‡ªåŠ¨ç­¾åˆ°æ ¸å¿ƒè„šæœ¬
const COOKIE_KEY = "ccb_auth_cookie";
const SIGN_URL = "https://mrhf.chengchao.com.cn/ccb-internal-sit/mobile/sign/doSign";

// ä¸»æ‰§è¡Œå‡½æ•°
(async () => {
    try {
        const cookie = $prefs.valueForKey(COOKIE_KEY);
        if (!cookie) {
            throw new Error("æœªæ‰¾åˆ°Cookieï¼Œè¯·é‡æ–°ç™»å½•APP");
        }
        
        // æ‰§è¡Œç­¾åˆ°
        const signResult = await $task.fetch({
            url: SIGN_URL,
            method: "POST",
            headers: {
                "Cookie": cookie,
                "User-Agent": "CCB/Dream/Version 7.0.0 iPhone iOS 17.3.1",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                activityId: "DAILY_SIGN",
                userId: getUserId(cookie),
                deviceId: generateDeviceId()
            })
        });
        
        // å¤„ç†ç»“æœ
        const data = JSON.parse(signResult.body);
        if (data.code === "SUCCESS" || data.code === "ALREADY_SIGNED") {
            // è®°å½•ç­¾åˆ°æ—¶é—´
            $prefs.setValueForKey(Date.now(), "ccb_last_sign");
            
            // è·å–ç§¯åˆ†ä½™é¢
            const points = await getPoints(cookie);
            
            // ç”Ÿæˆé€šçŸ¥
            $notification.post(
                "ğŸ‰ å»ºè¡Œç­¾åˆ°" + (data.code === "ALREADY_SIGNED" ? "å®Œæˆ" : "æˆåŠŸ"),
                data.code === "ALREADY_SIGNED" ? 
                    "ä»Šæ—¥å·²å®Œæˆç­¾åˆ°" : `è·èµ  ${data.pointsAwarded || 5} ç§¯åˆ†`,
                `ğŸ’° æ€»ç§¯åˆ†: ${points.total}åˆ† | æ¬¡æ—¥å¯é¢†: ${points.tomorrow || 0}åˆ†`
            );
        } else {
            throw new Error(data.message || "ç­¾åˆ°å¤±è´¥");
        }
    } catch (e) {
        $notification.post("âŒ ç­¾åˆ°å¤±è´¥", e.message, "è¯·æ‰‹åŠ¨ç­¾åˆ°ä¸€æ¬¡");
    }
})();

// å·¥å…·å‡½æ•°
function getUserId(cookie) {
    const match = cookie.match(/USER_ID=([^;]+)/);
    return match ? match[1] : "default_user";
}

function generateDeviceId() {
    return "IOS_" + Math.random().toString(36).substr(2, 10);
}

async function getPoints(cookie) {
    try {
        const response = await $task.fetch({
            url: "https://mrhf.chengchao.com.cn/ccb-internal-sit/mobile/points/getTotalPoints?timestamp=" + Date.now(),
            headers: {
                "Cookie": cookie,
                "User-Agent": "CCB/Dream/Version 7.0.0 iPhone iOS 17.3.1"
            }
        });
        const data = JSON.parse(response.body);
        return {
            total: data.totalPoints || "æœªçŸ¥",
            tomorrow: data.nextDayPoints || 0
        };
    } catch {
        return { total: "æœªçŸ¥", tomorrow: 0 };
    }
}

// ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¿å­˜è‡ªèº«URL
if (typeof $task !== 'undefined') {
    $prefs.setValueForKey($task.url, "ccb_sign_url");
}
